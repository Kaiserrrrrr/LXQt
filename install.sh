#!/bin/bash

# Enable Performance Mode 
export MAKEFLAGS="-j$(nproc)"; sudo sed -i "s/-j2/-j$(nproc)/g" /etc/makepkg.conf 2>/dev/null; sudo sed -i 's/COMPRESSXZ=(xz -c -z -)/COMPRESSXZ=(xz -c -z - --threads=0)/g' /etc/makepkg.conf 2>/dev/null; echo performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor 2>/dev/null

# Installation Script
sudo sed -i '/\[multilib\]/,/Include/s/^#//' /etc/pacman.conf; sudo pacman -Syu --noconfirm --needed; CPU_VENDOR=$(grep -m1 'vendor_id' /proc/cpuinfo); IS_BROADCOM=$(lspci -n | grep -c "14e4:"); IS_NVIDIA=$(lspci -n | grep -c "10de:"); IS_LAPTOP=$([ -d /sys/class/power_supply/BAT* ] || [ -d /sys/class/input/mouse* ] && echo 1 || echo 0); DRIVERS="sof-firmware alsa-firmware tlp thermald mesa lib32-mesa intel-media-driver"; [[ "$CPU_VENDOR" =~ "GenuineIntel" ]] && DRIVERS+=" intel-ucode vulkan-intel" || DRIVERS+=" amd-ucode"; [[ "$IS_BROADCOM" -gt 0 ]] && DRIVERS+=" broadcom-wl"; [[ "$IS_NVIDIA" -gt 0 ]] && DRIVERS+=" nvidia nvidia-utils nvidia-settings lib32-nvidia-utils"; [[ "$IS_LAPTOP" -eq 1 ]] && DRIVERS+=" xf86-input-libinput"; sudo pacman -S --noconfirm --needed $DRIVERS lxqt-session lxqt-panel lxqt-config lxqt-qtplugin lxqt-powermanagement lxqt-notificationd lxqt-policykit lxqt-globalkeys lxqt-runner lxqt-themes lximage-qt pcmanfm-qt qterminal breeze-icons gvfs falkon neovim fastfetch htop mpv nano bc ncdu git light-locker xorg-server lightdm lightdm-gtk-greeter pipewire-audio pavucontrol-qt alsa-utils bluez bluez-utils blueman networkmanager network-manager-applet xdg-utils picom; sudo sed -i 's/#greeter-session=.*/greeter-session=lightdm-gtk-greeter/' /etc/lightdm/lightdm.conf; sudo systemctl enable lightdm bluetooth.service NetworkManager.service tlp.service thermald.service; mkdir -p ~/.config/pcmanfm-qt/lxqt/ && echo -e "[General]\ntrust_all_desktop_files=true" > ~/.config/pcmanfm-qt/lxqt/settings.conf; mkdir -p ~/.config/autostart; echo -e "[Desktop Entry]\nType=Application\nExec=picom -b\nName=Picom" > ~/.config/autostart/picom.desktop; echo -e "[Desktop Entry]\nType=Application\nExec=nm-applet\nName=Network Manager" > ~/.config/autostart/nm-applet.desktop; echo -e "[Desktop Entry]\nType=Application\nExec=blueman-applet\nName=Bluetooth Manager" > ~/.config/autostart/blueman.desktop; echo -e "[Desktop Entry]\nType=Application\nExec=light-locker\nName=Light Locker" > ~/.config/autostart/light-locker.desktop; sudo chown -R $USER:$USER ~/.config; wait

# Cleanup Script
sudo pacman -Rns $(pacman -Qtdq) --noconfirm 2>/dev/null; STAY_INTEL=$(lscpu | grep -ic "Intel"); STAY_AMD=$(lspci | grep -icE "amd|radeon"); STAY_NVIDIA=$(lspci | grep -ic "nvidia"); [[ $STAY_INTEL -eq 0 ]] && sudo rm -rf /usr/lib/firmware/intel* 2>/dev/null; [[ $STAY_AMD -eq 0 ]] && sudo rm -rf /usr/lib/firmware/amdgpu /usr/lib/firmware/radeon 2>/dev/null; [[ $STAY_NVIDIA -eq 0 ]] && sudo rm -rf /usr/lib/firmware/nvidia 2>/dev/null; sudo rm -rf /usr/lib/firmware/{liquidio,qcom,netronome,nfp,mellanox,kaweth,ti-connectivity,mediatek,marvell,cavium,qed} 2>/dev/null; sudo sed -i '/^#en_.*\.UTF-8 UTF-8/s/^#//' /etc/locale.gen; sudo rm -f /usr/lib/locale/locale-archive; sudo locale-gen; sudo find /usr/share/locale/ -maxdepth 1 -mindepth 1 -not -name 'en*' -not -name 'locale.alias' -exec rm -rf {} + 2>/dev/null; sudo find /usr/share/{doc,man,info,gtk-doc} -type f -delete 2>/dev/null; sudo find /usr/lib/modules -name "*.ko" -print0 | xargs -0 -P $(nproc) strip --strip-debug 2>/dev/null; sudo journalctl --vacuum-size=50M; sudo sed -i 's/#SystemMaxUse=/SystemMaxUse=50M/' /etc/systemd/journald.conf; sudo systemctl restart systemd-journald; rm -rf ~/.cache/* 2>/dev/null; sudo pacman -Scc --noconfirm; 

# Disable Performance Mode
echo powersave | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor 2>/dev/null; wait; sync; sudo reboot
